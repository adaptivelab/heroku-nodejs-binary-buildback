#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# debug
# set -x

# clean up leaking environment
unset GIT_DIR

# config
if [ !$NODE_VERSION ]; then
  NODE_VERSION='0.8.16'
fi

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=`cd $(dirname $0); cd ..; pwd`

function tar_download() {
  url="$1"
  location="$2"

  mkdir -p $location
  curl $url -s -o - | tar xzf - -C $location
}

# downloading node
echo "-----> Downloading node"
tar_download http://nodejs.org/dist/v$NODE_VERSION/node-v$NODE_VERSION-linux-x64.tar.gz $BUILD_DIR
mv $BUILD_DIR/node-v$NODE_VERSION-linux-x64 $BUILD_DIR/node
chmod +x $BUILD_DIR/node/bin/*
ls $BUILD_DIR/node

# install dependencies with npm
echo "-----> Installing dependencies with npm"
$BUILD_DIR/node/bin/npm install -g node-gyp
cd $BUILD_DIR
$BUILD_DIR/node/bin/npm install --production
echo "Dependencies installed" | indent

echo "-----> Building runtime environment"
mkdir -p $BUILD_DIR/.profile.d
echo "export PATH=\"\$HOME/node/bin:$HOME/bin:\$HOME/node_modules/.bin:\$PATH\"" > $BUILD_DIR/.profile.d/nodejs.sh